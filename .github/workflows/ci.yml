name: CI

on:
  push:
    branches: [ main, testing2 ]
  pull_request:
    branches: [ main ]

# Required permissions for creating check runs with test results
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: memory

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cortexdb_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B compile --file pom.xml

      - name: Run Tests
        id: test
        run: |
          mvn -B test --file pom.xml || TEST_EXIT_CODE=$?
          echo "test_exit_code=${TEST_EXIT_CODE:-0}" >> $GITHUB_OUTPUT
          exit ${TEST_EXIT_CODE:-0}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_CHAT_MODEL: gemini-2.0-flash
          GEMINI_EMBED_MODEL: text-embedding-004

      - name: Parse Test Results
        id: test_results
        if: always()
        run: |
          TESTS_RUN=0
          TESTS_FAILED=0
          TESTS_ERRORS=0
          TESTS_SKIPPED=0
          
          # Parse XML files for accurate test counts
          for file in target/surefire-reports/TEST-*.xml; do
            if [ -f "$file" ]; then
              RUN=$(grep -oP 'tests="\K[0-9]+' "$file" | head -1)
              FAILED=$(grep -oP 'failures="\K[0-9]+' "$file" | head -1)
              ERRORS=$(grep -oP 'errors="\K[0-9]+' "$file" | head -1)
              SKIPPED=$(grep -oP 'skipped="\K[0-9]+' "$file" | head -1)
              
              TESTS_RUN=$((TESTS_RUN + ${RUN:-0}))
              TESTS_FAILED=$((TESTS_FAILED + ${FAILED:-0}))
              TESTS_ERRORS=$((TESTS_ERRORS + ${ERRORS:-0}))
              TESTS_SKIPPED=$((TESTS_SKIPPED + ${SKIPPED:-0}))
            fi
          done
          
          TESTS_PASSED=$((TESTS_RUN - TESTS_FAILED - TESTS_ERRORS - TESTS_SKIPPED))
          
          echo "total=$TESTS_RUN" >> $GITHUB_OUTPUT
          echo "passed=$TESTS_PASSED" >> $GITHUB_OUTPUT
          echo "failed=$TESTS_FAILED" >> $GITHUB_OUTPUT
          echo "errors=$TESTS_ERRORS" >> $GITHUB_OUTPUT
          echo "skipped=$TESTS_SKIPPED" >> $GITHUB_OUTPUT

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results: ${{ steps.test_results.outputs.passed }}/${{ steps.test_results.outputs.total }} passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.test_results.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.test_results.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.test_results.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | ${{ steps.test_results.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${{ steps.test_results.outputs.total }}** |" >> $GITHUB_STEP_SUMMARY

      - name: Publish Test Report
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: 'memory/target/surefire-reports/TEST-*.xml'
          fail_on_failure: true
          require_tests: true
          detailed_summary: true
          include_passed: true
          check_name: "Tests (${{ steps.test_results.outputs.passed }}/${{ steps.test_results.outputs.total }})"

      - name: Fail if Tests Failed
        if: always() && steps.test.outputs.test_exit_code != '0'
        run: |
          echo "Tests failed with exit code ${{ steps.test.outputs.test_exit_code }}"
          exit 1
