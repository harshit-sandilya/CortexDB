name: CI

on:
  push:
    branches: [ main, testing2, query-engine ]
  pull_request:
    branches: [ main ]

# Required permissions for creating check runs with test results
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: memory

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cortexdb_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B compile --file pom.xml

      - name: Run Tests
        id: test
        run: |
          mvn -B test --file pom.xml || TEST_EXIT_CODE=$?
          echo "test_exit_code=${TEST_EXIT_CODE:-0}" >> $GITHUB_OUTPUT
          exit ${TEST_EXIT_CODE:-0}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_CHAT_MODEL: gemini-2.0-flash
          GEMINI_EMBED_MODEL: text-embedding-004

      - name: Parse Test Results
        id: test_results
        if: always()
        run: |
          # Parse from Maven surefire summary which is more reliable
          # Look for lines like: Tests run: 86, Failures: 0, Errors: 0, Skipped: 0
          SUMMARY=$(find target/surefire-reports -name "*.txt" -exec grep "Tests run:" {} \; | awk -F'[,:]' '
            BEGIN { run=0; fail=0; err=0; skip=0 }
            {
              for(i=1; i<=NF; i++) {
                gsub(/^[ \t]+|[ \t]+$/, "", $i)
                if ($i ~ /Tests run/) { gsub(/[^0-9]/, "", $(i+1)); run += $(i+1) }
                if ($i ~ /Failures/) { gsub(/[^0-9]/, "", $(i+1)); fail += $(i+1) }
                if ($i ~ /Errors/) { gsub(/[^0-9]/, "", $(i+1)); err += $(i+1) }
                if ($i ~ /Skipped/) { gsub(/[^0-9]/, "", $(i+1)); skip += $(i+1) }
              }
            }
            END { print run" "fail" "err" "skip }
          ')
          
          read TESTS_RUN TESTS_FAILED TESTS_ERRORS TESTS_SKIPPED <<< "$SUMMARY"
          TESTS_PASSED=$((${TESTS_RUN:-0} - ${TESTS_FAILED:-0} - ${TESTS_ERRORS:-0} - ${TESTS_SKIPPED:-0}))
          
          echo "total=${TESTS_RUN:-0}" >> $GITHUB_OUTPUT
          echo "passed=${TESTS_PASSED:-0}" >> $GITHUB_OUTPUT
          echo "failed=${TESTS_FAILED:-0}" >> $GITHUB_OUTPUT
          echo "errors=${TESTS_ERRORS:-0}" >> $GITHUB_OUTPUT
          echo "skipped=${TESTS_SKIPPED:-0}" >> $GITHUB_OUTPUT

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results: ${{ steps.test_results.outputs.passed }}/${{ steps.test_results.outputs.total }} passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.test_results.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.test_results.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.test_results.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | ${{ steps.test_results.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${{ steps.test_results.outputs.total }}** |" >> $GITHUB_STEP_SUMMARY

      - name: Publish Test Report
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: 'memory/target/surefire-reports/TEST-*.xml'
          fail_on_failure: true
          require_tests: true
          detailed_summary: true
          include_passed: true
          check_name: "Tests (${{ steps.test_results.outputs.passed }}/${{ steps.test_results.outputs.total }})"

      - name: Fail if Tests Failed
        if: always() && steps.test.outputs.test_exit_code != '0'
        run: |
          echo "Tests failed with exit code ${{ steps.test.outputs.test_exit_code }}"
          exit 1
