name: CI

on:
  push:
    branches: [ main, testing2, query-engine ]
  pull_request:
    branches: [ main ]

# Required permissions for creating check runs with test results
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: memory

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cortexdb_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B compile --file pom.xml

      - name: Run Tests
        id: test
        run: |
          mvn -B test --file pom.xml || TEST_EXIT_CODE=$?
          echo "test_exit_code=${TEST_EXIT_CODE:-0}" >> $GITHUB_OUTPUT
          exit ${TEST_EXIT_CODE:-0}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_CHAT_MODEL: gemini-2.0-flash
          GEMINI_EMBED_MODEL: text-embedding-004

      - name: Parse Test Results
        id: test_results
        if: always()
        shell: python
        run: |
          import os
          import glob
          import xml.etree.ElementTree as ET

          total = 0
          failures = 0
          errors = 0
          skipped = 0

          base_path = "target/surefire-reports"
          if os.path.exists(base_path):
              for file_path in glob.glob(os.path.join(base_path, "TEST-*.xml")):
                  try:
                      tree = ET.parse(file_path)
                      root = tree.getroot()
                      # Account for testsuite attributes
                      total += int(root.attrib.get("tests", 0))
                      failures += int(root.attrib.get("failures", 0))
                      errors += int(root.attrib.get("errors", 0))
                      skipped += int(root.attrib.get("skipped", 0))
                  except Exception as e:
                      print(f"Error parsing {file_path}: {e}")

          passed = total - failures - errors - skipped
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as fh:
              fh.write(f"total={total}\n")
              fh.write(f"passed={passed}\n")
              fh.write(f"failed={failures}\n")
              fh.write(f"errors={errors}\n")
              fh.write(f"skipped={skipped}\n")

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results: ${{ steps.test_results.outputs.passed }}/${{ steps.test_results.outputs.total }} passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.test_results.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.test_results.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.test_results.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | ${{ steps.test_results.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${{ steps.test_results.outputs.total }}** |" >> $GITHUB_STEP_SUMMARY

      - name: Publish Test Report
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: 'memory/target/surefire-reports/TEST-*.xml'
          fail_on_failure: true
          require_tests: true
          detailed_summary: true
          include_passed: true
          check_name: "Tests (${{ steps.test_results.outputs.passed }}/${{ steps.test_results.outputs.total }})"

      - name: Fail if Tests Failed
        if: always() && steps.test.outputs.test_exit_code != '0'
        run: |
          echo "Tests failed with exit code ${{ steps.test.outputs.test_exit_code }}"
          exit 1
