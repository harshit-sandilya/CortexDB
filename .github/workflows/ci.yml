name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

# Required permissions for creating check runs with test results
permissions:
  contents: read
  checks: write
  pull-requests: write

jobs:
  build:
    runs-on: ubuntu-latest
    
    defaults:
      run:
        working-directory: memory

    services:
      postgres:
        image: pgvector/pgvector:pg16
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: cortexdb_test
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn -B compile --file pom.xml

      - name: Run Tests
        id: test
        run: |
          set +e
          mvn -B test --file pom.xml 2>&1 | tee test-output.log
          TEST_EXIT_CODE=$?
          echo "test_exit_code=${TEST_EXIT_CODE}" >> $GITHUB_OUTPUT
          exit ${TEST_EXIT_CODE}
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          GEMINI_CHAT_MODEL: ${{ secrets.GEMINI_CHAT_MODEL}}
          GEMINI_EMBED_MODEL: ${{ secrets.GEMINI_EMBED_MODEL}}

      - name: Parse Test Results
        id: test_results
        if: always()
        run: |
          # Method 1: Parse from maven output (most reliable for summary)
          if [ -f test-output.log ]; then
            # Look for the final "Tests run:" line in Maven output
            MAVEN_SUMMARY=$(grep "Tests run:" test-output.log | tail -1)
            echo "Maven summary line: $MAVEN_SUMMARY"
            
            if [ -n "$MAVEN_SUMMARY" ]; then
              TESTS_RUN=$(echo "$MAVEN_SUMMARY" | grep -oP 'Tests run: \K[0-9]+' || echo "0")
              TESTS_FAILED=$(echo "$MAVEN_SUMMARY" | grep -oP 'Failures: \K[0-9]+' || echo "0")
              TESTS_ERRORS=$(echo "$MAVEN_SUMMARY" | grep -oP 'Errors: \K[0-9]+' || echo "0")
              TESTS_SKIPPED=$(echo "$MAVEN_SUMMARY" | grep -oP 'Skipped: \K[0-9]+' || echo "0")
            fi
          fi
          
          # Method 2: Fallback to XML parsing if maven output parsing failed
          if [ -z "$TESTS_RUN" ] || [ "$TESTS_RUN" = "0" ]; then
            echo "Falling back to XML parsing..."
            TESTS_RUN=0
            TESTS_FAILED=0
            TESTS_ERRORS=0
            TESTS_SKIPPED=0
            
            for file in target/surefire-reports/TEST-*.xml; do
              if [ -f "$file" ]; then
                echo "Processing: $file"
                # Use xmllint if available, otherwise grep
                if command -v xmllint &> /dev/null; then
                  tests=$(xmllint --xpath 'string(//testsuite/@tests)' "$file" 2>/dev/null || echo "0")
                  failures=$(xmllint --xpath 'string(//testsuite/@failures)' "$file" 2>/dev/null || echo "0")
                  errors=$(xmllint --xpath 'string(//testsuite/@errors)' "$file" 2>/dev/null || echo "0")
                  skipped=$(xmllint --xpath 'string(//testsuite/@skipped)' "$file" 2>/dev/null || echo "0")
                else
                  tests=$(grep -oP 'tests="\K[0-9]+' "$file" | head -1 || echo "0")
                  failures=$(grep -oP 'failures="\K[0-9]+' "$file" | head -1 || echo "0")
                  errors=$(grep -oP 'errors="\K[0-9]+' "$file" | head -1 || echo "0")
                  skipped=$(grep -oP 'skipped="\K[0-9]+' "$file" | head -1 || echo "0")
                fi
                
                TESTS_RUN=$((TESTS_RUN + ${tests:-0}))
                TESTS_FAILED=$((TESTS_FAILED + ${failures:-0}))
                TESTS_ERRORS=$((TESTS_ERRORS + ${errors:-0}))
                TESTS_SKIPPED=$((TESTS_SKIPPED + ${skipped:-0}))
              fi
            done
          fi
          
          # Calculate passed tests
          TESTS_PASSED=$((${TESTS_RUN:-0} - ${TESTS_FAILED:-0} - ${TESTS_ERRORS:-0} - ${TESTS_SKIPPED:-0}))
          
          # Set outputs
          echo "total=${TESTS_RUN:-0}" >> $GITHUB_OUTPUT
          echo "passed=${TESTS_PASSED:-0}" >> $GITHUB_OUTPUT
          echo "failed=${TESTS_FAILED:-0}" >> $GITHUB_OUTPUT
          echo "errors=${TESTS_ERRORS:-0}" >> $GITHUB_OUTPUT
          echo "skipped=${TESTS_SKIPPED:-0}" >> $GITHUB_OUTPUT
          
          # Debug output
          echo "=== Test Results Summary ==="
          echo "Total: ${TESTS_RUN:-0}"
          echo "Passed: ${TESTS_PASSED:-0}"
          echo "Failed: ${TESTS_FAILED:-0}"
          echo "Errors: ${TESTS_ERRORS:-0}"
          echo "Skipped: ${TESTS_SKIPPED:-0}"
          echo "==========================="

      - name: Test Summary
        if: always()
        run: |
          echo "## Test Results: ${{ steps.test_results.outputs.passed }}/${{ steps.test_results.outputs.total }} passed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Passed | ${{ steps.test_results.outputs.passed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Failed | ${{ steps.test_results.outputs.failed }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Errors | ${{ steps.test_results.outputs.errors }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Skipped | ${{ steps.test_results.outputs.skipped }} |" >> $GITHUB_STEP_SUMMARY
          echo "| **Total** | **${{ steps.test_results.outputs.total }}** |" >> $GITHUB_STEP_SUMMARY

      - name: Publish Test Report
        if: always()
        uses: mikepenz/action-junit-report@v4
        with:
          report_paths: 'memory/target/surefire-reports/TEST-*.xml'
          fail_on_failure: true
          require_tests: true
          detailed_summary: true
          include_passed: true
          check_name: "Tests (${{ steps.test_results.outputs.passed }}/${{ steps.test_results.outputs.total }})"

      - name: Fail if Tests Failed
        if: always() && steps.test.outputs.test_exit_code != '0'
        run: |
          echo "Tests failed with exit code ${{ steps.test.outputs.test_exit_code }}"
          exit 1